<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js ç²’å­æ‰‹åŠ¿äº’åŠ¨ç³»ç»Ÿ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; }
        
        /* æ‘„åƒå¤´å°çª—å£ - å³ä¸Šè§’ */
        #video-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
            background: #000;
            transform: scaleX(-1); /* é•œåƒ */
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #input_video { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

        /* åº•éƒ¨çŠ¶æ€æç¤º */
        #hint-box {
            position: absolute;
            bottom: 40px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 20;
        }
        #hint-icon {
            font-size: 50px;
            display: block;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0,255,255,0.8);
        }
        #hint-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 24px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 20px;
            border-radius: 20px;
            text-shadow: 0 0 10px #000;
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #00ffff;
            transition: opacity 0.8s;
        }
        .loading-bar {
            width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px;
        }
        .progress {
            width: 0%; height: 100%; background: #00ffff; transition: width 0.3s;
            animation: load 2s infinite ease-in-out;
        }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
    </style>
</head>
<body>

    <div id="loader">
        <h2>ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</h2>
        <div class="loading-bar"><div class="progress"></div></div>
        <p style="margin-top:10px; font-size:12px; color:#666;">è¯·å…è®¸æ‘„åƒå¤´æƒé™</p>
    </div>

    <div id="video-container">
        <video id="input_video" playsinline></video>
    </div>

    <div id="hint-box">
        <div id="hint-icon">ğŸ‘‹</div>
        <div id="hint-text">è¯·åœ¨æ‘„åƒå¤´å‰ä¼¸æ‰‹ (0-5æŒ‡)</div>
    </div>

    <!-- éšè—çš„ç”»å¸ƒï¼Œç”¨äºç”Ÿæˆæ–‡å­—åæ ‡ -->
    <canvas id="textCanvas" style="display:none;"></canvas>

    <!-- è„šæœ¬å¼•å…¥ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- é…ç½®åŒº ---
        const CONFIG = {
            particleCount: 24000,   // ç²’å­æ•°é‡ï¼Œè¶Šå¤šè¶Šæ¸…æ™°ä½†è¶Šå¡
            particleSize: 0.5,      // åŸºç¡€ç²’å­å¤§å°
            textScale: 0.18,        // æ–‡å­—ç¼©æ”¾æ¯”ä¾‹
            color: new THREE.Color('#00ffff'), // é»˜è®¤é’è‰²
            names: {
                1: "æ–¹æ¥šå…ƒ",
                2: "éƒ‘ç”°ç”°",
                3: "æ½˜é“­æ•",
                4: "é‚µå®‰å¦®"
            }
        };

        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, particles, geometry, material;
        let targetPositions; 
        let currentPositions; 
        let lastFingerCount = -1;

        // --- 1. ç¨‹åºåŒ–ç”Ÿæˆå‘å…‰ç²’å­è´´å›¾ (æ— éœ€å¤–éƒ¨å›¾ç‰‡) ---
        function createGlowTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶å¾„å‘æ¸å˜åœ†
            const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');   // ä¸­å¿ƒç™½
            gradient.addColorStop(0.4, 'rgba(255, 255, 255, 0.5)'); // ä¸­é—´äº®
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');         // è¾¹ç¼˜é€æ˜
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 32, 32);
            
            const texture = new THREE.CanvasTexture(canvas);
            return texture;
        }

        // --- 2. åˆå§‹åŒ– Three.js åœºæ™¯ ---
        function initThree() {
            scene = new THREE.Scene();
            // æ·»åŠ ä¸€ç‚¹é›¾æ•ˆå¢åŠ æ™¯æ·±
            scene.fog = new THREE.FogExp2(0x050505, 0.012);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 60; // æ‘„åƒæœºè·ç¦»

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.8;

            initParticles();
            
            // é»˜è®¤å…¨å±çŠ¶æ€
            transformToFullScreen();

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        // --- 3. åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ ---
        function initParticles() {
            geometry = new THREE.BufferGeometry();
            const count = CONFIG.particleCount;
            
            currentPositions = new Float32Array(count * 3);
            targetPositions = new Float32Array(count * 3);

            for (let i = 0; i < count * 3; i++) {
                // åˆå§‹éšæœºä½ç½®
                currentPositions[i] = (Math.random() - 0.5) * 300;
                targetPositions[i] = currentPositions[i];
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(currentPositions, 3));

            material = new THREE.PointsMaterial({
                size: CONFIG.particleSize,
                color: CONFIG.color,
                map: createGlowTexture(), // ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„è´´å›¾
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending, //ä»¥æ­¤è·å¾—å‘å…‰å åŠ æ•ˆæœ
                depthWrite: false
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- 4. æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡å­—è½¬ç²’å­ ---
        function transformToText(text) {
            const canvas = document.getElementById('textCanvas');
            // è®¾ç½®ç”»å¸ƒè¶³å¤Ÿå¤§ä»¥å®¹çº³é«˜æ¸…æ–‡å­—
            canvas.width = 1024;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å…¼å®¹ Mac å’Œ Windows çš„å­—ä½“è®¾ç½®
            ctx.font = "bold 160px 'Microsoft YaHei', 'PingFang SC', sans-serif";
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const validPixels = [];
            
            // åƒç´ é‡‡æ ·ï¼Œstep è¶Šå°ç²’å­è¶Šå¯†é›†
            const step = 4; 
            for (let y = 0; y < canvas.height; y += step) {
                for (let x = 0; x < canvas.width; x += step) {
                    const alpha = data[(y * canvas.width + x) * 4 + 3];
                    if (alpha > 128) {
                        validPixels.push({
                            x: (x - canvas.width / 2) * CONFIG.textScale,
                            y: -(y - canvas.height / 2) * CONFIG.textScale // Yè½´åè½¬
                        });
                    }
                }
            }

            updateTargets(validPixels, 0); // 0 è¡¨ç¤ºä¸éœ€è¦é¢å¤–çš„éšæœºæ‰©æ•£
            material.color.set('#ffffff'); // æ–‡å­—æ˜¾ç¤ºä¸ºç™½è‰²é«˜äº®
            material.size = CONFIG.particleSize * 1.3; // æ–‡å­—ç²’å­ç¨å¾®å¤§ä¸€ç‚¹
        }

        // --- 5. æ ¸å¿ƒåŠŸèƒ½ï¼šçˆ±å¿ƒå½¢çŠ¶ ---
        function transformToHeart() {
            const points = [];
            const count = 5000; 
            
            for (let i = 0; i < count; i++) {
                let t = Math.random() * Math.PI * 2;
                // ç»å…¸å¿ƒå½¢å…¬å¼
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                let z = (Math.random() - 0.5) * 6; // å¢åŠ åšåº¦
                
                points.push({ x: x * 1.5, y: y * 1.5, z: z });
            }
            
            updateTargets(points, 30); // 30 æ˜¯è®©å¤šä½™ç²’å­å˜æˆèƒŒæ™¯æ˜Ÿç©ºçš„èŒƒå›´
            material.color.set('#ff0066'); // ç²‰çº¢è‰²
            material.size = CONFIG.particleSize * 2.0;
        }

        // --- 6. æ ¸å¿ƒåŠŸèƒ½ï¼šå…¨å±æ‰©æ•£ ---
        function transformToFullScreen() {
            for (let i = 0; i < CONFIG.particleCount; i++) {
                const i3 = i * 3;
                targetPositions[i3] = (Math.random() - 0.5) * 250;
                targetPositions[i3+1] = (Math.random() - 0.5) * 150;
                targetPositions[i3+2] = (Math.random() - 0.5) * 150;
            }
            material.color.set(CONFIG.color);
            material.size = CONFIG.particleSize;
        }

        // --- è¾…åŠ©ï¼šæ›´æ–°ç›®æ ‡æ•°ç»„ ---
        function updateTargets(validPoints, spreadRange) {
            for (let i = 0; i < CONFIG.particleCount; i++) {
                const i3 = i * 3;
                if (i < validPoints.length) {
                    // ç»„æˆå½¢çŠ¶çš„ç²’å­
                    targetPositions[i3] = validPoints[i].x;
                    targetPositions[i3+1] = validPoints[i].y;
                    targetPositions[i3+2] = validPoints[i].z || 0;
                } else {
                    // å¤šä½™çš„ç²’å­ï¼šé£å‘èƒŒæ™¯å˜æˆæ˜Ÿç©º
                    targetPositions[i3] = (Math.random() - 0.5) * 300;
                    targetPositions[i3+1] = (Math.random() - 0.5) * 200;
                    targetPositions[i3+2] = (Math.random() - 0.5) * 100 - 50; 
                }
            }
        }

        // --- 7. åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);

            // ç²’å­ç§»åŠ¨æ’å€¼ (Lerp)
            const speed = 0.08; 
            const positions = geometry.attributes.position.array;

            for (let i = 0; i < CONFIG.particleCount; i++) {
                const i3 = i * 3;
                // ç¼“åŠ¨åŠ¨ç”»ï¼šå½“å‰ä½ç½®è¶‹å‘äºç›®æ ‡ä½ç½®
                positions[i3] += (targetPositions[i3] - positions[i3]) * speed;
                positions[i3+1] += (targetPositions[i3+1] - positions[i3+1]) * speed;
                positions[i3+2] += (targetPositions[i3+2] - positions[i3+2]) * speed;
                
                // æ·»åŠ è½»å¾®çš„å‘¼å¸/æµ®åŠ¨æ•ˆæœ
                if (lastFingerCount === 0 || lastFingerCount === 5) {
                    positions[i3+1] += Math.sin(Date.now() * 0.001 + positions[i3] * 0.1) * 0.02;
                }
            }

            geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // --- 8. AI æ‰‹åŠ¿è¯†åˆ« ---
        function initMediaPipe() {
            const videoElement = document.getElementById('input_video');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            hands.onResults(handleHandResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 320, height: 240
            });
            
            cameraUtils.start()
                .then(() => document.getElementById('loader').style.display = 'none')
                .catch(err => {
                    alert("æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼è¯·ç¡®ä¿å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´ã€‚");
                    console.error(err);
                });
        }

        function countExtendedFingers(landmarks) {
            let count = 0;
            // ç®€å•çš„Yè½´åˆ¤æ–­æ³•ï¼šæŒ‡å°–åœ¨æŒ‡æ ¹ä¸Šæ–¹
            const tips = [8, 12, 16, 20]; // é£ŸæŒ‡ã€ä¸­æŒ‡ã€æ— åæŒ‡ã€å°æŒ‡
            const bases = [6, 10, 14, 18];
            
            // æ‹‡æŒ‡éœ€ç‰¹æ®Šåˆ¤æ–­ï¼ˆXè½´ï¼‰
            // åˆ¤æ–­å·¦å³æ‰‹ç¨å¾®å¤æ‚ï¼Œè¿™é‡Œç®€åŒ–åˆ¤æ–­æ‹‡æŒ‡æŒ‡å°–åˆ°å°æŒ‡æ ¹éƒ¨çš„è·ç¦»æ˜¯å¦å¤Ÿè¿œ
            const thumbTip = landmarks[4];
            const pinkyBase = landmarks[17];
            const indexBase = landmarks[5];
            
            // æ‹‡æŒ‡ä¼¸å‡ºåˆ¤æ–­
            const thumbDist = Math.hypot(thumbTip.x - pinkyBase.x, thumbTip.y - pinkyBase.y);
            const indexDist = Math.hypot(indexBase.x - pinkyBase.x, indexBase.y - pinkyBase.y);
            if (thumbDist > indexDist * 1.2) count++;

            // å…¶ä»–å››æŒ‡
            for (let i = 0; i < 4; i++) {
                if (landmarks[tips[i]].y < landmarks[bases[i]].y) count++;
            }
            return count;
        }

        function handleHandResults(results) {
            const icon = document.getElementById('hint-icon');
            const text = document.getElementById('hint-text');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const fingers = countExtendedFingers(results.multiHandLandmarks[0]);

                if (fingers !== lastFingerCount) {
                    lastFingerCount = fingers;
                    
                    if (fingers === 0) {
                        transformToHeart();
                        icon.innerText = "â¤ï¸"; text.innerText = "çˆ±å¿ƒæ¨¡å¼";
                    } else if (fingers === 5) {
                        transformToFullScreen();
                        icon.innerText = "âœ¨"; text.innerText = "æ»¡å±æ‰©æ•£";
                    } else if (CONFIG.names[fingers]) {
                        transformToText(CONFIG.names[fingers]);
                        icon.innerText = ["â˜ï¸", "âœŒï¸", "ğŸ‘Œ", "ğŸ––"][fingers-1];
                        text.innerText = `å±•ç¤ºï¼š${CONFIG.names[fingers]}`;
                    }
                }
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // å¯åŠ¨
        initThree();
        initMediaPipe();

    </script>
</body>
</html>
